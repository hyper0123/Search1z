name: Scan AstraPanel Hosts

on:
  workflow_dispatch:
    inputs:
      COUNTRY:
        description: "CÃ³digo del paÃ­s (ej: AR, PE, CL)"
        required: true

jobs:
  collect-hosts:
    runs-on: ubuntu-latest
    env:
      COUNTRY: ${{ github.event.inputs.COUNTRY }}
      PLAY_PATH: playlist.m3u

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Debug Shodan raw JSON
        id: shodan_debug
        env:
          SHODAN_KEY: ${{ secrets.SHODAN_API_KEY }}
        run: |
          QUERY='http.title:"Astra Control Panel" country:'${COUNTRY}
          URL="https://api.shodan.io/shodan/host/search?key=${SHODAN_KEY}&query=${QUERY}&limit=5"
          echo "Curling Shodan URL: $URL"
          curl -s "$URL" -o shodan_debug.json || true
          echo "â†’ Shodan raw JSON (primeras 20 lÃ­neas):"
          head -n 20 shodan_debug.json || true
          echo "â†’ Total resultados Shodan: $(jq '.total // 0' shodan_debug.json)"

      - name: Extract Shodan URLs
        id: extract_shodan
        env:
          SHODAN_KEY: ${{ secrets.SHODAN_API_KEY }}
        run: |
          QUERY='http.title:"Astra Control Panel" country:'${COUNTRY}
          URL="https://api.shodan.io/shodan/host/search?key=${SHODAN_KEY}&query=${QUERY}&limit=500"
          curl -s "$URL" \
            | jq -r '.matches[] | "http://\(.ip_str):\(.port)/${PLAY_PATH}"' > shodan_urls.txt || touch shodan_urls.txt

      - name: Debug ZoomEye raw JSON
        id: zoomeye_debug
        env:
          ZOOMEYE_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
        run: |
          QUERY='title:"Astra Control Panel" country:'${COUNTRY}
          curl -s -H "API-KEY: $ZOOMEYE_KEY" \
            "https://api.zoomeye.org/host/search?query=${QUERY}&page_size=5" \
            -o zoomeye_debug.json || true
          echo "â†’ ZoomEye raw JSON (primeras 20 lÃ­neas):"
          head -n 20 zoomeye_debug.json || true
          echo "â†’ Total resultados ZoomEye: $(jq '.matches | length' zoomeye_debug.json)"

      - name: Extract ZoomEye URLs
        id: extract_zoomeye
        env:
          ZOOMEYE_KEY: ${{ secrets.ZOOMEYE_API_KEY }}
        run: |
          QUERY='title:"Astra Control Panel" country:'${COUNTRY}
          curl -s -H "API-KEY: $ZOOMEYE_KEY" \
            "https://api.zoomeye.org/host/search?query=${QUERY}&page_size=50" \
            | jq -r '.matches[] | select(.portinfo.port != null) | "http://\(.ip):\(.portinfo.port)/${PLAY_PATH}"' > zoomeye_urls.txt || touch zoomeye_urls.txt

      - name: Debug FOFA raw JSON
        id: fofa_debug
        env:
          FOFA_EMAIL: ${{ secrets.FOFA_EMAIL }}
          FOFA_KEY: ${{ secrets.FOFA_API_KEY }}
        run: |
          QUERY='title="Astra Control Panel" country='${COUNTRY}
          curl -s "https://fofa.info/api/v1/search/all?email=${FOFA_EMAIL}&key=${FOFA_KEY}&q=${QUERY}" \
            -o fofa_debug.json || true
          echo "â†’ FOFA raw JSON (primeras 20 lÃ­neas):"
          head -n 20 fofa_debug.json || true
          echo "â†’ Total resultados FOFA: $(jq '.results | length' fofa_debug.json)"

      - name: Extract FOFA URLs
        id: extract_fofa
        env:
          FOFA_EMAIL: ${{ secrets.FOFA_EMAIL }}
          FOFA_KEY: ${{ secrets.FOFA_API_KEY }}
        run: |
          QUERY='title="Astra Control Panel" country='${COUNTRY}
          curl -s "https://fofa.info/api/v1/search/all?email=${FOFA_EMAIL}&key=${FOFA_KEY}&q=${QUERY}" \
            | jq -r '.results[] | "http://" + .[0] + ":" + .[1] + "/${PLAY_PATH}"' > fofa_urls.txt || touch fofa_urls.txt

      - name: Unir y deduplicar URLs
        run: |
          cat shodan_urls.txt zoomeye_urls.txt fofa_urls.txt 2>/dev/null | sort -u > all_hosts.txt
          echo "Total Ãºnicos encontrados: $(wc -l < all_hosts.txt)"

      - name: Commit de resultados
        run: |
          mkdir -p data/${COUNTRY}
          cp all_hosts.txt data/${COUNTRY}/urls.txt
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add data/${COUNTRY}/urls.txt
          git commit -m "ðŸ” URLs Astra Control Panel para ${COUNTRY}" || echo "Nada nuevo para commitear"
          git push
